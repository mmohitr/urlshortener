# URL Shortener

The URL Shortener Service is a web application designed to simplify the sharing of long and cumbersome URLs by providing shortened and user-friendly alternatives. This project aims to create a **robust, user-friendly, and scalable** URL shortening service that includes features such as **custom short URLs, user history tracking, and tier-based rate limiting**.

## Requirements Overview

### 1. Create an endpoint that takes in a long URL and returns a shortened one with a random short ending. Creation of a user preferred url is recommended over a random url (not mandatory)

The requirement is satisfied by allowing users to specify their preferred URLs using the optional "short_url" field. When this field is not provided, a random short URL is generated by default.

#### Sample JSON Request WITH a user-preferred short url 
```json
{
    "long_url": "https://github.com/mmohitr?tab=repositories",
    "short_url": "mmrgit"
}
```
#### Sample JSON Response for POST
```json
{
    "id": 1,
    "user_id": 1,
    "long_url": "https://github.com/mmohitr?tab=repositories",
    "short_url": "http://short.url/mmrgit"
}
```

#### Sample JSON Request WITHOUT a user-preferred short url 
```json
{
    "long_url": "https://github.com/mmohitr?tab=repositories"
}
```
#### Sample JSON Response for POST
```json
{
    "id": 2,
    "user_id": 1,
    "long_url": "https://github.com/mmohitr?tab=repositories",
    "short_url": "http://short.url/pnqtp"
}
```

### 2. Create an endpoint that returns a history of all URLs shortened by a given user.

The getUrls endpoint takes user ID as a parameter and fetches all the short URLs generated by that specific user.

#### Sample JSON Response 
```json
[
    {
        "id": 1,
        "user_id": 1,
        "long_url": "https://github.com/mmohitr?tab=repositories",
        "short_url": "http://short.url/mmrgit"
    },
    {
        "id": 2,
        "user_id": 1,
        "long_url": "https://www.linkedin.com/in/marutimohitr",
        "short_url": "http://short.url/mmrl"
    }
]
```

### 3. Make the short urls actually redirect to their long url counterparts.

- The project features a dedicated endpoint for URL redirection when users access a short URL.
- Authentication and authorization checks are performed to validate the user's permission to access the short URL.
- The long URL associated with the requested short URL is retrieved from the database.
- The HTTP status code is set to 301 (Permanent Redirect) to signify that the short URL is being permanently redirected to the long URL.
- The response includes a "Location" header with the long URL as the target, guiding clients to follow the redirection automatically.

This seamless process ensures that users are effectively redirected to the original, longer URL, thereby fulfilling the requirement for actual URL redirection.

### 4. Requests should be tier based. For example a Tier 1 user can make 1000 requests whereas Tier 2 user can make only 100 requests. You are free to define different levels of tier-ing

The project assumes 5 levels if tiering as follows:
- Tier 1: Up to 1000 requests
- Tier 2: Up to 500 requests
- Tier 3: Up to 100 requests
- Tier 4: Up to 50 requests
- Tier 5: Up to 25 requests

The getUser route takes user ID as a parameter and fetches the total available requests and the number of requests a user made at any given point in time.

#### Sample JSON Response for GET
```json
{
    "id": 2,
    "first_name": "david",
    "last_name": "b",
    "username": "david@gmail.com",
    "tier": 2,
    "requests_available": 499,
    "requests_made": 1,
    "account_created": "2023-11-05T17:05:40.4040-05:00"
}
```


## Features
1. **Shorten Long URLs:** Users can input long URLs into the service, which will generate a unique and compact short URL for easy sharing.
2. **Custom Short URLs:** Registered users have the option to create custom short URLs, allowing for personalization and easy-to-remember links.
3. **Redirection:** Short URLs redirect users to the original, longer URLs. This ensures that users can access the intended web pages.
4. **User History:** Users can access a history of all URLs they have shortened.
5. **Rate Limiting:** The service implements tier-based rate limiting for different types of users. For example, Tier 1 users have a higher rate limit than Tier 2 users, and so on.

## Prerequisites 
The following packages need to be installed before running this project:
- **bcrypt:** A library for securely hashing and salting passwords
- **dotenv:** A utility for loading environment variables from a .env file into Node.js applications
- **express:** A web application framework for Node.js that simplifies the creation of web APIs and routes
- **moment:** A JavaScript library for parsing, validating, manipulating, and formatting dates and times
- **nodemon:** A utility that monitors for changes in your Node.js application and automatically restarts the server when code changes occur during development
- **pg:** A Node.js client for PostgreSQL, enabling interactions with PostgreSQL databases
- **sequelize:** An ORM (Object-Relational Mapping) library for Node.js that simplifies database interactions, including database schema creation and querying

Run the following command to install the dependencies:

```
npm i bcrypt dotenv express moment nodemon pg sequelize
```

## Implementation

## All Endpoints

### Users

### 1. GET route to check server healthy: 
- The getStatus function checks the health of the server by attempting to authenticate with a database using Sequelize. 
- If the authentication is successful, it responds with "Server healthy"; otherwise, it responds with "Server unhealthy" and includes the error details.
```
http://localhost:3000/healthz
```

### 2. GET route to retrieve user details
- This route handles a GET request to retrieve user details based on the provided user ID, with error handling for invalid input and authorization checks. 
- If authorized, it fetches and sends user details, excluding the password, as a JSON response.
```
http://localhost:3000/user/{userId}
```
#### Sample JSON Response for GET
```json
{
    "id": 2,
    "first_name": "david",
    "last_name": "b",
    "username": "david@gmail.com",
    "tier": 2,
    "requests_available": 499,
    "requests_made": 1,
    "account_created": "2023-11-05T17:05:40.4040-05:00"
}
```
### 3. POST route to add a new user to database
- This route handles a POST request to add a new user to the database, **adhering to tier-based request limits**. 
- It performs various checks, including validating the request body, required fields, the uniqueness of the username, and the user's tier. - The system **sets the available requests based on the user's tier**, ensuring that, for example, a Tier 1 user can make 1000 requests, while a Tier 2 user can make only 100 requests. 
- If all checks pass, it hashes the user's password, creates a new user in the database, and returns the user's details (excluding the password) with a 201 status code. If any of the checks fail, it responds with a 400 status and an appropriate error message.
```
http://localhost:3000/user
```
#### Sample JSON Request for POST
```json
{
    "first_name": "mohit",
    "last_name": "r",
    "username": "mohit@gmail.com",
    "password": "password",
    "tier": 1
}
```
#### Sample JSON Response for POST
```json
{
    "id": 1,
    "first_name": "mohit",
    "last_name": "r",
    "username": "mohit@gmail.com",
    "tier": 1,
    "requests_available": 1000,
    "requests_made": 0,
    "account_created": "2023-11-05T17:04:23.2323-05:00"
}
```

### URLs

### 1. GET route to retrieve URLs of a user
- This route handles a GET request to **retrieve all URLs associated with a user** based on their user ID. 
- It includes error handling for invalid input and authorization checks. If authorized, it fetches and sends the user's URLs (excluding sensitive information) as a JSON response with a 200 status code. 
- If any checks fail, it responds with a 400 status or 401 status as appropriate, along with the corresponding error message.
```
http://localhost:3000/url/{userId}
```
#### Sample JSON Response for GET
```json
[
    {
        "id": 1,
        "user_id": 1,
        "long_url": "https://github.com/mmohitr?tab=repositories",
        "short_url": "http://short.url/mmrgit"
    },
    {
        "id": 2,
        "user_id": 1,
        "long_url": "https://www.linkedin.com/in/marutimohitr",
        "short_url": "http://short.url/mmrl"
    }
]
```

### 2. POST route to generate a new short URL
- The addCustomUrl function handles a POST request to add a URL to the database. It allows users the **option to specify a user-preferred short URL** by including it in the optional "short_url" field.
-  If a user-preferred short URL is not provided, the service will **generate a random short URL**. 
- The function performs checks for authorization, request body content, required fields, and known fields. If authorized and all checks pass, it creates a new URL record in the database, deducts available requests, and returns the URL details. 
- If any checks fail, it responds with the corresponding status code and error message.
```
http://localhost:3000/url/custom
```
#### Sample JSON Request for POST
```json
{
    "long_url": "https://github.com/mmohitr?tab=repositories",
    "short_url": "mmrgit"
}
```
#### Sample JSON Response for POST
```json
{
    "id": 1,
    "user_id": 1,
    "long_url": "https://github.com/mmohitr?tab=repositories",
    "short_url": "http://short.url/mmrgit"
}
```

### 3. GET route to redirect a short URL
- The redirect route **ensures that short URLs are effectively redirected to their corresponding long URLs**. 
- It performs checks for the validity of the request, including authorization and user authentication. 
- Upon successful authentication, it **retrieves the long URL associated with the provided short URL, sets up a 301 (Permanent Redirect) status, and utilizes the "Location" header to instruct the client to follow the redirection to the long URL counterpart**, thereby achieving URL redirection.
```
http://localhost:3000/url/{userId}/redirect
```
#### Sample JSON Request for GET
```json
{
    "short_url": "short.url/mmrgit"
}
